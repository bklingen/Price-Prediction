---
title: "AIC"
author: "Thomas FitzGerald and Mei Maddox"
date: '2022-10-13'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
options(knitr.duplicate.label = 'allow')
knitr::opts_chunk$set(echo = TRUE, warnings = FALSE, message = FALSE)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=70))
```

```{r read.previous, echo=FALSE}
source(knitr::purl("../KaggleHousePrices.Rmd", quiet = TRUE))
```

```{r libraries, include=FALSE}
library(splines)
library(MASS)
```

```{r}
lm.obj.init<-lm(SalePrice ~ 1,data=train)
lm.obj.full<-lm(SalePrice ~ .,data=train)

lm.fAIC<-stepAIC(lm.obj.init,direction=c("forward"), scope=list(upper=lm.obj.full,lower=lm.obj.init), trace=0)
lm.bAIC<-stepAIC(lm.obj.full,direction=c("backward"), trace=0)
lm.dAIC<-step(lm.obj.full,direction=c("both"), scope=list(upper=lm.obj.full,lower=lm.obj.init), trace=0)

fAIC.prediction<-predict(lm.fAIC, newdata=test, interval="prediction")
bAIC.prediction<-predict(lm.bAIC, newdata=test, interval = "prediction")
dAIC.prediction<-predict(lm.dAIC, newdata=test, interval="prediction")
```

```{r}
c(summary(lm.fAIC)$fstatistic[1],summary(lm.fAIC)$r.squared,dim(as.data.frame(lm.fAIC$coefficients))[1])
c(summary(lm.bAIC)$fstatistic[1],summary(lm.bAIC)$r.squared,dim(as.data.frame(lm.bAIC$coefficients))[1])
c(summary(lm.dAIC)$fstatistic[1],summary(lm.dAIC)$r.squared,dim(as.data.frame(lm.dAIC$coefficients))[1])
```
"both" and "backward" AIC gave us the same model, so we'll just run forward/backward from here and compare those two.

```{r}
plot(lm.bAIC,which=c(1))
plot(lm.fAIC,which=c(1))
```
Three houses (524,692,1171) had extremely high residuals, with 692 & 1171 also having high leverage.
```{r}
train[c(524,692,1171),]
```
692 is also the highest sale price in the training set, so it makes sense that it's skewing the model somewhat.  524 is a newer house on a fairly large, irregular lot with a low sale price, while 1171 is an older house on a fairly small lot.

I decided to drop these three when fitting the model.
```{r}
train.temp<-train %>%
  filter(!row_number() %in% c(524,692,1171))

lm.obj.init<-lm(SalePrice ~ 1,data=train.temp)
lm.obj.full<-lm(SalePrice ~ .,data=train.temp)

lm.fAIC.2<-stepAIC(lm.obj.init,direction=c("forward"), scope=list(upper=lm.obj.full,lower=lm.obj.init), trace=0)
lm.bAIC.2<-stepAIC(lm.obj.full,direction=c("backward"), trace=0)
lm.dAIC.2<-step(lm.obj.full,direction=c("both"), scope=list(upper=lm.obj.full,lower=lm.obj.init), trace=0)

fAIC.2.prediction<-predict(lm.fAIC.2, newdata=test, interval="prediction")
bAIC.2.prediction<-predict(lm.bAIC.2, newdata=test, interval = "prediction")
dAIC.2.prediction<-predict(lm.dAIC.2, newdata=test, interval="prediction")
plot(lm.fAIC.2,which=c(1))
plot(lm.bAIC.2,which=c(1))
```

```{r}
c(summary(lm.bAIC.2)$fstatistic,summary(lm.bAIC.2)$r.squared)
c(summary(lm.fAIC.2)$fstatistic,summary(lm.fAIC.2)$r.squared)
c(summary(lm.dAIC.2)$fstatistic,summary(lm.dAIC.2)$r.squared)
dim(as.data.frame(lm.bAIC.2$coefficients))
dim(as.data.frame(lm.fAIC.2$coefficients))
dim(as.data.frame(lm.dAIC.2$coefficients))
```

Next, let's take a quick look at how our training set's price distribution compares with the predicted values for our test set.
```{r}
quantile(train$SalePrice,na.rm=TRUE,probs=c(0,.05,.25,.50,.75,.95,1))
quantile(bAIC.prediction,na.rm=TRUE,probs=c(0,.05,.25,.50,.75,.95,1))
quantile(fAIC.prediction,na.rm=TRUE,probs=c(0,.05,.25,.50,.75,.95,1))
quantile(bAIC.2.prediction,na.rm=TRUE,probs=c(0,.05,.25,.50,.75,.95,1))
quantile(fAIC.2.prediction,na.rm=TRUE,probs=c(0,.05,.25,.50,.75,.95,1))
```
The values below $0 are obviously wrong, and the top percentile predictions are probably wrong too, being more than twice the highest sale price in the training set.  We're going to cap predictions at the 1st and 99th percentile of the test set, respectively.
```{r}
low.q<-quantile(train$SalePrice,na.rm=TRUE,probs=c(.01))
high.q<-quantile(train$SalePrice,na.rm=TRUE,probs=c(.99))

fAIC.prediction[,1][fAIC.prediction[,1]<=low.q]<-low.q
fAIC.prediction[,1][fAIC.prediction[,1]>=high.q]<-high.q
bAIC.prediction[,1][bAIC.prediction[,1]<=low.q]<-low.q
bAIC.prediction[,1][bAIC.prediction[,1]>=high.q]<-high.q
fAIC.2.prediction[,1][fAIC.2.prediction[,1]<=low.q]<-low.q
fAIC.2.prediction[,1][fAIC.2.prediction[,1]>=high.q]<-high.q
bAIC.2.prediction[,1][bAIC.2.prediction[,1]<=low.q]<-low.q
bAIC.2.prediction[,1][bAIC.2.prediction[,1]>=high.q]<-high.q
```

```{r}
df.output<-as.data.frame(cbind(test$Id,bAIC.2.prediction[,1]))
colnames(df.output)<-c('Id','SalePrice')
write.csv(df.output,'..\\AIC_prediction.csv')
```
